<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home Movie Archive</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  select, button { margin: 5px 0; padding: 5px; }
  #results { margin-top: 20px; }
</style>
</head>
<body>
<h2>Home Movie Archive</h2>

<label>People:</label>
<select id="people"><option value="">--Any--</option></select><br>

<label>Place:</label>
<select id="place"><option value="">--Any--</option></select><br>

<label>Event:</label>
<select id="event"><option value="">--Any--</option></select><br>

<label>Date:</label>
<select id="date"><option value="">--Any--</option></select><br>

<button onclick="search()">Search</button>

<div id="results"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
let movies=[], people=[], places=[], events=[], dates=[];

// Load CSVs
function loadCSV(filename, callback) {
  Papa.parse(filename, {download: true, header: true, complete: callback});
}

// Populate dropdowns
function populateDropdown(selectId, data, column) {
  const select = document.getElementById(selectId);
  const values = Array.from(new Set(data.map(x => x[column]))).sort();
  values.forEach(v => {
    if(v) {
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      select.appendChild(opt);
    }
  });
}

// Load all data sequentially
loadCSV("Movies.csv", r => { movies = r.data;
  loadCSV("People.csv", r2 => { people = r2.data; populateDropdown("people", people, "Name");
    loadCSV("Places.csv", r3 => { places = r3.data; populateDropdown("place", places, "Place");
      loadCSV("Events.csv", r4 => { events = r4.data; populateDropdown("event", events, "Event");
        loadCSV("Dates.csv", r5 => { dates = r5.data; populateDropdown("date", dates, "Date"); });
      });
    });
  });
});

// Normalize clip numbers for comparison (strip leading zeroes)
const normalize = cn => cn ? String(Number(cn)) : "";

function search(){
  const p = document.getElementById("people").value;
  const pl = document.getElementById("place").value;
  const e = document.getElementById("event").value;
  const d = document.getElementById("date").value;

  let clipSets = [];

  // Collect all matching Clip Numbers for each filter
  if(p) clipSets.push(new Set(people.filter(x=>x.Name===p).map(x=>normalize(x["Clip Number"]))));
  if(pl) clipSets.push(new Set(places.filter(x=>x.Place===pl).map(x=>normalize(x["Clip Number"]))));
  if(e) clipSets.push(new Set(events.filter(x=>x.Event===e).map(x=>normalize(x["Clip Number"]))));
  if(d) clipSets.push(new Set(dates.filter(x=>x.Date===d).map(x=>normalize(x["Clip Number"]))));

  // Intersect sets if multiple filters selected
  let result = clipSets.length ? [...clipSets.reduce((a,b)=>new Set([...a].filter(x=>b.has(x))))] : movies.map(x=>normalize(x["Clip Number"]));

  // Show filenames along with original Clip Numbers
  const output = result.map(cn => {
    const movie = movies.find(m => normalize(m["Clip Number"]) === cn);
    return movie ? `${movie["Clip Number"]} â†’ ${movie.Filename}` : cn;
  });

  document.getElementById("results").innerHTML = output.length ? output.join("<br>") : "No matching clips found.";
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home Movie Archive</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    select, button {
      margin: 5px;
      padding: 5px;
    }
    #results {
      margin-top: 20px;
      font-weight: bold;
    }
    ul {
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h2>Home Movie Archive</h2>
  <p>Select filters to find matching clips:</p>

  <label for="people">Person:</label>
  <select id="people"><option value="">--Any--</option></select>

  <label for="places">Place:</label>
  <select id="places"><option value="">--Any--</option></select>

  <label for="events">Event:</label>
  <select id="events"><option value="">--Any--</option></select>

  <label for="dates">Date:</label>
  <select id="dates"><option value="">--Any--</option></select>

  <div>
    <button onclick="search()">Search</button>
  </div>

  <div id="results"></div>

  <script>
    let movies = {};
    let people = [];
    let places = [];
    let events = [];
    let dates = [];

    async function loadCSV(url) {
      // Force fresh copy from GitHub (skip cache)
      const response = await fetch(url + "?t=" + new Date().getTime());
      const text = await response.text();
      return text.trim().split("\n").slice(1).map(line => line.split(","));
    }

    async function loadData() {
      const moviesData = await loadCSV("Movies.csv");
      movies = {};
      moviesData.forEach(row => {
        movies[row[0]] = row[1];
      });

      people = await loadCSV("People.csv");
      places = await loadCSV("Places.csv");
      events = await loadCSV("Events.csv");
      dates = await loadCSV("Dates.csv");

      populateDropdown("people", people.map(r => r[1]));
      populateDropdown("places", places.map(r => r[1]));
      populateDropdown("events", events.map(r => r[1]));
      populateDropdown("dates", dates.map(r => r[1]));
    }

    function populateDropdown(id, values) {
      const unique = [...new Set(values)];
      const select = document.getElementById(id);
      select.innerHTML = "<option value=''>--Any--</option>";
      unique.forEach(v => {
        const option = document.createElement("option");
        option.value = v;
        option.textContent = v;
        select.appendChild(option);
      });
    }

    function search() {
      const selectedPerson = document.getElementById("people").value;
      const selectedPlace = document.getElementById("places").value;
      const selectedEvent = document.getElementById("events").value;
      const selectedDate = document.getElementById("dates").value;

      let results = Object.keys(movies);

      if (selectedPerson) {
        results = results.filter(r => people.some(p => p[0] === r && p[1] === selectedPerson));
      }
      if (selectedPlace) {
        results = results.filter(r => places.some(p => p[0] === r && p[1] === selectedPlace));
      }
      if (selectedEvent) {
        results = results.filter(r => events.some(p => p[0] === r && p[1] === selectedEvent));
      }
      if (selectedDate) {
        results = results.filter(r => dates.some(p => p[0] === r && p[1] === selectedDate));
      }

      const resultsDiv = document.getElementById("results");
      if (results.length > 0) {
        resultsDiv.innerHTML = "Clips matching your selection:<ul>" + results.map(r => `<li>${r}</li>`).join("") + "</ul>";
      } else {
        resultsDiv.textContent = "No clips found for that selection.";
      }
    }

    // Always load fresh data on page load
    loadData();
  </script>
</body>
</html>
